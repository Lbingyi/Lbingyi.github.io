
{include file="public/header" /}
{include file="user/top" /}
<section class="container" id="jaxcontainer">
{include file="user/left" /}
<script src="__PLUG__/bootstrap-table/bootstrap-table.min.js"></script>
<script src="__PLUG__/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
<script src="__PLUG__/layer/layer.js"></script>
<style>
.head-title .head-icon {
    background: #64bfff;
    display: inline-block;
    height: 18px;
    margin-right: 10px;
    vertical-align: middle;
    width: 3px;
    border-radius: 2px;
    overflow: hidden;
	vertical-align: -3px;
}

.leng-section ul li:hover {
    border-color: #66ccff;
    background: #fff;
    color: #66ccff;
}

.change {
    border:1px solid #66ccff;
    background: #fff;
    color: #66ccff;
    margin-right: 40px;
    line-height: 66px;
    letter-spacing: -0.5px;
    width: 168px;
    height: 66px;
    float: left;
    margin: 0 15px;
    font-size: 16px;
    transition: all .5s;
    position: relative;
    text-align: center
}



.tooltip{
    margin-right: 40px;
    line-height: 66px;
    letter-spacing: -0.5px;
    width: 168px;
    height: 66px;
    border: 1px solid #e5e5e5;
    background: #eee;
    float: left;
    margin: 0 15px 15px;
    font-size: 16px;
    transition: all .5s;
    position: relative;
    text-align: center
}

.leng-section ul li.leng-detail span.price-num ins {
    font-size: 14px;
    vertical-align: 2px;
    margin-left: 2px;
}

.leng-section ul li.leng-detail ins.name {
    letter-spacing: -1px;
}

ins {
    color: #000;
    text-decoration: none;
}

.leng-section ul li.leng-detail em.priceMoney {
    font-size: 22px;
}

.leng-section ul li.leng-detail strong.priceDigital {
    position: absolute;
    display: block;
    top: 0px;
    left: 0px;
    width: 100%;
    z-index: 999;
    text-indent: -990em;
}

.price-section .price-group {
    background: #fdfdfd;
    border-radius: 2px;
}

.price-section .price-group .price-detail {
    display: table-cell;
    padding: 20px;
}

.pay-summary .amounted {
    font-size: 24px;
    font-weight: bolder;
    margin: 0 3px;
    letter-spacing: 1px;
    color: #ff6633;
}

.pay-summary .amounted #paymoney {
    font-size: 24px;
    letter-spacing: -1px;
    vertical-align: -2px;
    margin-right: 2px;
    font-size: 34px;
}

.pay {
    padding: 0 20px;
    height: 50px;
    line-height: 50px
}

.pay .icon img {
	width: 100%;
	height: 100%
}

.QRcode {
    width: 650px;
    margin: 100px auto 0;
    height: 255px;
    position: relative;
}

.QRcode .orderMsg {
    position: absolute;
    top: 50%;
    left: 280px;
    transform: translateY(-50%);
}

.QRcode .orderMsg .order {
    color: #fff;
    font-size: 20px;
    text-align: left
}

.QRcode-pay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #000;
    opacity: 0.8;
    display: none;
    z-index: 999;
}

.QRcode .pic img {
    width: 255px
}

.QRcode .QRcode-txt {
    color: #fff;
    font-size: 25px;
    text-align: center
}

.QRcode-pay .close {
    float: right;
    margin-top: 5px;
    margin-right: 5px;
    width: 30px;
    height: 30px;
    background: url('__PUBLIC__/static/images/close.png');
    background-size: 100% 100%;
    cursor: pointer;
}

.icon .submit {
    display: inline-block;
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 99;
    opacity: 0;
}

</style>
<div class="member-content" id="contentframe">

		<div class="head-title ovh" style="font-size:16px; line-height:54px; padding:0 20px 0;border-bottom: 2px solid #ccc;">
			<span class="head-icon" style="width:5px; height:24px; vertical-align:-6px"></span>
			选择套餐
		</div>
		<div class="leng-section s50" data-type="50"  style="display:block;padding: 40px;border-bottom: 2px dotted #ccc;overflow: hidden;">
			<ul id="s50">
                {foreach $card_type as $vo}
                    <li data-type="{$vo.goods_id}" procuct-name="{$vo.name}" data-product="{$vo.typeid}" data-product-price="{$vo.money}" class="leng-detail tooltip">
                        <span class="price-num"><ins class="name">{$vo.name}</ins>
                            <span class="priceMoney" style="font-size:18px; font-weight:bold; color: #ef0505;>{$vo.money}</span>
                            <strong class="priceDigital">{$vo.money}</strong>
                            <ins>元</ins>
                        </span>
                    </li>
                {/foreach}																					
			</ul>
		</div>
		<div class="price-section" style="padding:10px 0 0">
            <dl class="price-group">
                <dd class="price-detail" style="padding: 10px 20px">
                    <div class="pay-summary"><span class="amounted"><span style="font-size:16px; color:#333333">应付金额</span> ￥<span id="paymoney"></span>元</span></div>
                </dd>
            </dl>
		</div>
		<div class="pay">
            <p style="float: left;margin-right: 20px;font-size: 16px;font-weight: bolder;color: #333333;">选择支付方式</p>
<!-- 			<span id="wechat" class="icon" style="width: 118px;height: 42px;display: inline-block;margin-right: 30px;cursor: pointer;">
				<img src="__PUBLIC__/static/images/wechat.png" alt="">
			</span> -->
            <span class="icon" style="width: 118px;height: 42px;display: inline-block;position: relative;">
                <img src="__PUBLIC__/static/images/alipay.png" alt="">
                <input id="alipay" class="submit" type="submit" value="submit">
            </span>
            <p id="prompt" style="font-size: 16px;color: red"></p>
        </div>
        <div id="QRcodePay" class="QRcode-pay">
            <span id="close" class="close"></span>
            <div class="QRcode">
                <div class="pic" style="float: left;margin-right: 20px">
                    <img id="QRcode-pic" src="" alt="">
                    <p class="QRcode-txt">扫一扫付款</p>
                </div>
                <div class="orderMsg">
                    <p class="order">商品名称：<span id="product-name"></span></p>
                    <p class="order">订单编号：<span id="order-number"></span></p>
                    <p class="order">订单金额：<span id="order-price"></span>元</p>
                </div>
                
            </div>
        </div>

</div>


</section>
{include file="public/flooter" /}

<script type="text/javascript">
    let flag = 1
    //关闭二维码的遮罩层
    $('#close').click(function() {
        $('#QRcodePay').css('display','none')
        flag = 2
    })
    let data = null
    // 默认选中第一个产品
    // 默认显示第一个产品的金额
    $('.leng-section ul li:first').removeClass('tooltip').addClass('change')  
    $('#paymoney').text($('.leng-section ul li:first').attr('data-product-price')) 
    // 默认发送第一个产品的数据
    data = {
            'goods_id': $('.leng-section ul li:first').attr('data-type'),
            'typeid': $('.leng-section ul li:first').attr('data-product'),
            'num': 1,
        }
    // 给每个产品添加点击事件
    // 拿到产品的数据
    // 改变选中产品的样式
    $('.leng-section ul li').click(function() {
        
        $('#paymoney').text($(this).attr('data-product-price'))
        $(this).removeClass('tooltip').addClass('change').siblings().removeClass('change').addClass('tooltip')

        //遮罩层显示的信息
        $('#product-name').text($(this).attr('product-name'))
        data = {
            'goods_id': $(this).attr('data-type'),
            'typeid': $(this).attr('data-product'),
            'num': 1,
        }
    })
    //点击微信
    //拿到付款码显示出来
    // 付款成功后跳转到我的订单
    $('#wechat').click(() => {
        flag = 1
        weChat()
    })
    //点击支付宝
    $('#alipay').click(() => {
        data['pay_type'] = 2
        $.ajax({
            type: "POST",
            url: "{:url('home/goods/pay')}",
            data: data,
            success: function(msg) {
                if (msg.code == 1) {
                    $('#prompt').empty()
                    $('#QRcodePay').html(msg.msg.html)
                } else if (msg.code == 105) {
                    $('#prompt').empty()
                    layer.alert('库存不足,请联系客服！');
                } else if (msg.code == 106) {
                    $('#prompt').text(msg.msg)
                }
            }
        })
    })
    // 发起微信支付的请求
    function weChat() {
        data['pay_type'] = 1
        $.ajax({   	
		    type: "POST",
		    url: "{:url('home/goods/pay')}",
		    data: data,
		    success: function(msg) {			
                if (msg.code == 1) {
                    $('#prompt').empty()
                    $('#QRcode-pic').attr('src',msg.msg.url)
                    //遮罩层显示的信息
                    $('#product-name').text(msg.msg.data.goods_name)                               //商品名称
                    $('#order-number').text(msg.msg.data.ordersn)                               //订单编号
                    $('#order-price').text(msg.msg.data.amount)                                //订单价格
                    $('#QRcodePay').css('display','block')
                    Get_Wx_Pay_status()
                } else if (msg.code == 105) {
                    $('#prompt').empty()
                    layer.alert('库存不足,请联系客服！');
                } else if (msg.code == 106) {
                    $('#prompt').text(msg.msg)
                }
		    }
	    });
    }
    //请求支付是否成功的状态
    function Get_Wx_Pay_status() {
        if (flag == 2) {
            return false
        }
        setTimeout(function() {
            $.ajax({
                type: "POST",
                url: "{:url('home/goods/Get_Wx_Pay_status')}",
                success: function(msg) {
                    if (msg.status == 1) {
                        flag = 2
                        $('#QRcodePay').css('display','none')
                        window.location.replace("{:url('/home/order/index')}")
                    } else if (msg.status == 2) {
                        flag = 2
                        layer.alert('支付失败')
                        $('#QRcodePay').css('display','none')
                    } else {
                        Get_Wx_Pay_status()
                    }
                }
            })
        }, 1000)
    }
</script>